# 開発の共通ルール

## コーディング最小ルール
- フォーマッタ・Lintは必ず実行してからPRを出す（ローカル/CI両方）。
- importは自動整形に従う（手動で並べ替えない）。
- 改行コードはLFで統一（設定済み）。
- 変更は最小限・目的と関係ない整形は避ける。

## 命名
- 変数/関数: lowerCamelCase
- 型/コンポーネント: PascalCase
- 定数: UPPER_SNAKE_CASE

## 識別子（ISBN）正規化ルール
- 対象: `Volume.isbn` として保存する値。
- 保存前に必ず以下の順で正規化する。
  1. 前後の空白を除去する。
  2. 全角数字を半角数字へ変換する。
  3. ハイフン（`-`）を除去する。
- 正規化後の値が `^[0-9]{13}$`（半角数字13桁）でない場合は保存しない。
- DBには「半角数字13桁・ハイフンなし」のみを保存する。
- 例:
  - 入力: `978-4-08-883644-0`
  - 保存値: `9784088836440`

## 書影データ取り扱いルール（MVP）
- backend の責務は `cover_url`（URL文字列）の抽出・保存・返却までとする。
- backend は画像バイナリを保持しない（DBのBLOB保存、Base64保存、ファイル保存を行わない）。
- backend は画像のプロキシ配信・リサイズ・変換・キャッシュを行わない。
- frontend は `cover_url` を使って画像を直接表示し、取得失敗時はプレースホルダ表示で吸収する。
- 画像配信やキャッシュを導入する場合は、MVP外として別Epicで責務と運用を定義してから実装する。

## 未登録候補抽出の品質方針（MVP）
- 候補抽出はベストエフォートとし、抽出精度の完全保証は目標にしない。
- 誤判定リスクは作品詳細の確認モーダルで吸収する方針を固定する。
- 誤判定ゼロを目指すための過剰な自動判定実装（大規模な追加照合や複雑ルールの肥大化）はMVP外とする。

## APIエラーレスポンス規約
- 対象: backend が返すすべての `4xx` / `5xx` レスポンス。
- レスポンス形式は必ず以下に統一する。

```json
{
  "error": {
    "code": "SOME_ERROR_CODE",
    "message": "エラー内容を示すメッセージ",
    "details": {}
  }
}
```

- `error.code`
  - クライアント分岐に使う機械可読な識別子。
  - `UPPER_SNAKE_CASE` で固定し、文言変更で値を変えない。
  - 命名は `ドメイン_原因`（例: `SERIES_NOT_FOUND`, `NDL_API_UNAVAILABLE`）を基本とする。
- `error.message`
  - 人が読むための説明。
  - 表示向け文言として扱い、クライアント側の分岐条件には使わない。
- `error.details`
  - 追加情報を入れるオブジェクト。
  - 追加情報がない場合も `{}` を返し、`null` やキー省略はしない。
  - キー名は `lowerCamelCase` で統一する。
- HTTPステータスと `error.code` は常に整合させる（例: `404` + `SERIES_NOT_FOUND`）。

### ステータス別の運用方針

| ケース | HTTPステータス | `error.code` の方針 | `details` の方針 |
|---|---|---|---|
| 重複（ユニーク制約違反、二重登録） | `409` | `*_ALREADY_EXISTS` または `*_CONFLICT` | 重複判定に使ったキーを返す（例: `isbn`） |
| 未存在（ID指定取得・削除対象なし） | `404` | `*_NOT_FOUND` | 対象識別子を返す（例: `seriesId`） |
| 外部依存失敗（上流不正応答） | `502` | `*_BAD_GATEWAY` | `upstream`、必要に応じて `statusCode` |
| 外部依存失敗（上流タイムアウト） | `504` | `*_TIMEOUT` | `upstream`、必要に応じて `timeoutSeconds` |

- 外部依存失敗は、接続不可・DNS失敗なども含めて「上流サービスが期待どおり応答しない」ケースとして扱う。
- `502` と `504` の選択基準:
  - 期限内に応答は来たが内容/状態が不正: `502`
  - 期限内に応答が来ない: `504`

### エラーJSON例

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "リクエストパラメータが不正です。",
    "details": {
      "fieldErrors": [
        {
          "field": "title",
          "reason": "required"
        }
      ]
    }
  }
}
```

```json
{
  "error": {
    "code": "SERIES_NOT_FOUND",
    "message": "指定されたシリーズが見つかりません。",
    "details": {
      "seriesId": 123
    }
  }
}
```

```json
{
  "error": {
    "code": "NDL_API_UNAVAILABLE",
    "message": "外部書誌サービスに接続できませんでした。",
    "details": {
      "upstream": "NDL Search",
      "retryable": true
    }
  }
}
```

## PR運用の最小ルール
- 1PR = 1目的（小さく出す）
- PR本文に「目的」「変更概要」「動作確認」「影響範囲」を必ず記載
- CI（lint/format-check）が通っていることがレビュー前提
- 大きな変更は事前にIssueで合意
