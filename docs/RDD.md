# **漫画管理アプリ（蔵書目録）要件定義書（MVP・NDL Search版）**

## **1. 背景・目的**

### **1.1 背景**

物理漫画を所持していると、すでに持っている巻を忘れて **二重購入**が発生しやすい。巻数が増えるほど把握が難しく、購入前の確認コストが上がる。

### **1.2 目的**

**「登録されている＝持っている」** の単純なルールで、所持巻の有無を即時確認できる状態を作り、二重購入を防止する。

### **1.3 MVPのコア価値**

* 所持蔵書の可視化（作品単位で集約）  
* 所持内検索で即確認  
* 外部検索→所持判定→登録の導線  
* 作品詳細で未所持巻の確認と登録ができる  
* 重複登録防止と安全な削除

---

## 

## **2. 対象・非対象**

### **2.1 対象**

* **物理漫画（ISBN等の識別子がある書籍）**

### **2.2 非対象（MVP外）**

* Web漫画・電子書籍の所持管理  
* ユーザー認証、同期、複数端末共有  
* 読了/未読、購入予定などの状態管理

---

## **3. 技術前提（MVP）**

* Frontend: Next.js（React）+ TypeScript  
* Backend: FastAPI（Python）  
* DB: SQLite（Dockerは使わない）  
* 外部書誌: 国立国会図書館サーチ（NDL Search）  
* バーコードスキャン: ブラウザカメラ（例：html5-qrcode等）

---

## **4. 用語定義**

* **Series（作品）**：作品単位（タイトル、著者、出版社など）  
* **Volume（巻）**：巻単位（識別子＝ISBNを主キー相当として扱う）  
* **所持内検索**：DBに登録済み（所持済み）だけを検索する  
* **外部検索**：NDL Searchで書誌候補を検索する  
* **所持判定**：候補の識別子がDBに存在するかで所持済み/未所持を判定する  
* **未登録巻候補**：作品詳細ページ上段に表示する「未所持の候補巻」

---

## 

## **5. 画面構成**

## **5.1 画面一覧（2タブ \+ 登録導線 \+ 作品詳細）**

* **タブ1：ライブラリ（メイン）**  
  * 所持Series一覧（代表表紙付き）  
  * 所持内検索（title OR author）  
  * ヘッダーに「登録」ボタン（ワンクリックでスキャン画面へ）  
  * Seriesクリックで作品詳細へ  
* **タブ2：検索（サブ）**  
  * 外部検索（NDL Search）  
  * 所持判定（所持済み/未所持）  
  * 未所持の登録  
* **スキャン画面（登録画面）**  
  * バーコード読み取り→登録  
  * 最終手段の手入力（折りたたみ）  
* **作品詳細ページ**  
  * 未登録巻候補（上段）/登録済み巻（下段）の2段横スクロール  
  * 確認モーダルで登録  
  * 指定巻削除 / 全巻削除（物理削除）

---

## 

## **6. 機能要件**

## **6.1 ライブラリ（メイン）**

### **6.1.1 表示要件**

* Seriesカード一覧を表示する  
* **各Seriesカードは「所持している第1巻の表紙」を代表画像として表示する**  
  * 表紙が無い場合はプレースホルダ画像  
* 表示項目  
  * タイトル（必須）  
  * 著者（取得できる場合）  
  * 出版社（任意）  
* **ライブラリ画面では巻数情報を表示しない**（巻情報は作品詳細へ）

### **6.1.2 所持内検索**

* 対象：所持データ（DB）のSeries  
* 検索条件：`title OR author`

### **6.1.3 代表表紙（第1巻表紙）の決定ロジック**

優先順位：

1. `volume_number = 1` の巻が存在し `cover_url` がある場合はそれ  
2. 1巻が不明の場合は、当該Series内で `registered_at` が最も古い巻の `cover_url`  
3. `cover_url` が無い場合はプレースホルダ

---

## **6.2 登録（スキャン + 手入力）**

### **6.2.1 登録導線**

* ライブラリ画面のヘッダーに **「登録」ボタン**を配置（右上or左上に固定）  
* ワンクリックでスキャン画面へ遷移

### **6.2.2 スキャン登録**

* バーコード読み取り→識別子（ISBN）を抽出し正規化（前後空白除去、全角→半角、ハイフン除去）  
* 正規化後のISBNは半角数字13桁を必須とし、DBには「ハイフンなし13桁」のみ保存する  
* 登録結果（成功/登録済み/失敗）を表示  
* 連続スキャン対策  
  * 二重送信防止（処理中ロック）  
  * 同一識別子の短時間連打を無視（クールダウン）

### **6.2.3 手入力（最終手段）**

* スキャン/検索で取得できない場合の救済として提供  
* UIは折りたたみで、主導線にしない

---

## **6.3 検索タブ（外部検索）**

### **6.3.1 外部検索**

* 入力：キーワード（作品名/著者名など）  
* NDL Searchで検索し候補一覧を表示

### **6.3.2 結果表示**

* タイトル、著者（可能なら）、出版社（可能なら）、書影（可能なら）  
* 候補ごとに **所持済み/未所持** を表示

### **6.3.3 登録**

* 未所持候補は登録ボタンを表示  
* 登録後、所持済みに表示更新する

---

## **6.4 作品詳細ページ（Series詳細）**

### **6.4.1 目的**

* 作品単位で「未所持候補の確認→登録」「所持巻の管理（追加/削除）」を行う。

### **6.4.2 表示（必須）**

* 作品情報（タイトル必須、著者/出版社任意）  
* **2段横スクロール**  
  * 上段：未登録巻候補（未所持）  
  * 下段：登録済み巻（所持）  
* 登録済み巻が0の場合、下段は非表示でよい

### **6.4.3 書影がない場合の表示（採用）**

* 書影あり：表紙画像を表示  
* **書影なし：巻数を大きく表示するプレースホルダカード**を表示  
  * 例：「1巻」「2巻」  
  * 巻数不明の場合は「?巻」を許容

### **6.4.4 未登録候補→確認→登録（必須）**

* 上段の候補をクリックすると確認モーダル  
* 「登録する/しない」を選択  
* 登録後、上段から下段へ移動（UI更新）

### **6.4.5 削除（必須）**

* 指定巻削除（巻単位）  
* 全巻削除（作品単位）  
  * 実行前の確認ダイアログ必須  
  * **全巻削除は物理削除**（作品レコードも削除する）

---

## **6.5 未登録巻候補の抽出（NDL Search）**

### **6.5.1 方針**

* 候補抽出はベストエフォート  
* 誤判定リスクは「確認モーダル」で吸収する

### **6.5.2 除外フィルタ（採用）**

未登録候補抽出時、タイトル等に以下の語を含む結果を除外する（拡張可）：

* 特装版  
* 電子版 / 電子書籍  
* Kindle / \[Kindle版\]  
* その他、形態違いを示す明確な語

### **6.5.3 重複排除（採用）**

* 候補一覧内で **同一の識別子（ISBN 13桁）** が複数ある場合は1件にまとめる

---

## 

## **7. データ要件（DB）**

## **7.1 テーブル**

### **Series（作品）**

* `id`（PK）  
* `title`（必須）  
* `author`（任意）  
* `publisher`（任意）  
* `created_at`

### **Volume（巻）**

* `isbn`（必須・ユニーク）  
* `series_id`（必須・FK）  
* `volume_number`（任意）  
* `cover_url`（任意）  
* `registered_at`

## **7.2 制約**

* `Volume.isbn` ユニーク（重複登録防止）  
* `Volume.isbn` は正規化済みの半角数字13桁のみ保存する  
* `series_id` 外部キー（SQLiteのFK有効化が前提）

## **7.3 全巻削除時の扱い（採用）**

* 作品詳細での全巻削除は **Series/Volumeともに物理削除**  
* 削除済みステータス管理はMVP外

---

## 

## **8. API要件（概要）**

### **8.1 所持（DB）**

* `GET /api/library`（Series一覧。代表表紙URLを含む）  
* `GET /api/library?q=...`（title OR author）  
* `GET /api/series/{series_id}`（作品詳細：作品情報＋登録済み巻）  
* `POST /api/volumes`（登録：body `{isbn}`）  
* `DELETE /api/volumes/{isbn}`（指定巻削除）  
* `DELETE /api/series/{series_id}/volumes`（全巻削除＝物理削除）

#### **8.1.1 GET /api/library（ライブラリ一覧）**

フロントのライブラリ画面（所持Series一覧）で使用するエンドポイント。

**HTTPメソッド/パス**

* `GET /api/library`

**クエリパラメータ**

| パラメータ | 型 | 必須 | 説明 |
|---|---|---|---|
| `q` | string | 任意 | `title OR author` の部分一致検索キーワード |

`q` の扱いは以下で固定する。

* `q` 未指定、`q=`、空白のみ（例: `"   "`）は「検索なし」とみなし、全件を返す  
* 前後空白はトリムしてから検索する  
* 検索条件は `title LIKE %q% OR author LIKE %q%`（部分一致）  
* `author` が `null` のSeriesは、検索時に空文字として扱う（エラーにしない）

**レスポンス（200 OK）**

配列で返す。1要素が1Series。

| フィールド | 型 | `null` | 説明 |
|---|---|---|---|
| `id` | number | 不可 | Series ID |
| `title` | string | 不可 | 作品タイトル |
| `author` | string | 可 | 著者名 |
| `publisher` | string | 可 | 出版社名 |
| `representative_cover_url` | string | 可 | ライブラリカードで使う代表表紙URL |

並び順は以下で固定する。

* `created_at DESC`, `id DESC`（新しく作成されたSeriesが先頭）

`representative_cover_url` は以下優先順位で決定する。

1. `volume_number = 1` の巻で、`cover_url` が空でないもの  
2. 1が無い場合、同一Series内で `registered_at` が最古の巻の `cover_url`  
3. `cover_url` が1件も無い場合は `null`

**レスポンス例（検索なし）**

```json
[
  {
    "id": 12,
    "title": "葬送のフリーレン",
    "author": "山田鐘人",
    "publisher": "小学館",
    "representative_cover_url": "https://example.com/covers/frieren-1.jpg"
  },
  {
    "id": 11,
    "title": "作品B",
    "author": null,
    "publisher": "テスト出版社",
    "representative_cover_url": null
  }
]
```

**レスポンス例（`q` 指定あり）**

`GET /api/library?q=山田`

```json
[
  {
    "id": 12,
    "title": "葬送のフリーレン",
    "author": "山田鐘人",
    "publisher": "小学館",
    "representative_cover_url": "https://example.com/covers/frieren-1.jpg"
  }
]
```

**エラー**

* 4xx/5xx の形式は `docs/DEVELOPMENT_RULES.md` の「APIエラーレスポンス規約」に従う

### **8.2 外部検索（NDL Search）**

* `GET /api/catalog/search?q=...&limit=...`（検索タブ用：候補＋所持判定）  
* `GET /api/series/{series_id}/candidates`（作品詳細用：未登録候補。フィルタ＋重複排除済み）

### **エラー形式（統一）**

* エラー応答の正式仕様は `docs/DEVELOPMENT_RULES.md` の「APIエラーレスポンス規約」に従う  
* MVPでは以下のフォーマットを固定で採用する

```json
{
  "error": {
    "code": "SOME_ERROR_CODE",
    "message": "エラー内容を示すメッセージ",
    "details": {}
  }
}
```

---

## 

## **9. 非機能要件（MVP）**

* 数百巻規模で一覧・検索が体感遅くない  
* 外部検索はタイムアウトを設け、失敗時も画面が破綻しない  
* 重複登録・削除は安全側（確認/制約/エラー表示）で実装する

---

## **10. 完了定義（MVP Done）**

* ライブラリにSeriesが代表表紙付きで表示される（巻数は表示しない）  
* 所持内検索が title OR author で機能する  
* ヘッダー「登録」→スキャン→登録が成立する（成功/登録済み/失敗が分かる）  
* 検索タブで外部検索でき、所持判定が表示され、未所持を登録できる  
* 作品詳細で2段横スクロールが表示される（未登録/登録済み）  
* 未登録候補は確認モーダル経由で登録できる  
* 書影なしでも巻数プレースホルダで判別できる  
* 指定巻削除と全巻削除（物理削除）ができ、画面に反映される  
* 候補抽出で版違い除外と重複排除が効いている  
* データが永続化される（再起動後も保持）

---
